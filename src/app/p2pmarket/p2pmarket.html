<app-nav-tabs [tabs]="buytabs"></app-nav-tabs>

<div class="p2p-container">
  <!-- Thanh Mua/B√°n v√† T·∫°o qu·∫£ng c√°o -->
  <div class="top-bar">
    <div class="tabs">
      <span [class.active]="activeTab === 'buy'" (click)="activeTab = 'buy'">Mua</span>
      <span [class.active]="activeTab === 'sell'" (click)="activeTab = 'sell'">B√°n</span>
    </div>
    <button class="create-ad" (click)="CreateAdsPage()">T·∫°o qu·∫£ng c√°o</button>
  </div>

  <!-- B·ªô l·ªçc -->
  <div class="filters">
    <div class="filter-left">
      <div class="dropdown" [class.open]="dropdownOpen === 'coin'" (click)="$event.stopPropagation()">

        <button class="dropdown-btn" (click)="toggleDropdown('coin')">
          <img *ngIf="selectedCoin.icon" [src]="selectedCoin.icon" class="icon" />
          {{ selectedCoin.name }}
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"
            class="chevron" [class.open]="dropdownOpen === 'coin'">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
          </svg>
        </button>

        <div class="dropdown-menu" *ngIf="dropdownOpen === 'coin'">
          <input type="text" #searchCoinInput [value]="searchCoin" (input)="onSearch('coin', searchCoinInput.value)"
            placeholder="T√¨m ki·∫øm" class="search-box" (click)="$event.stopPropagation()" />
          <div class="dropdown-item" *ngFor="let coin of filteredCoinList" (click)="selectCoin(coin)">
            <img [src]="coin.icon" class="icon" />
            {{ coin.name }}
            <span *ngIf="coin.name === selectedCoin.name">‚úî</span>
          </div>
        </div>
      </div>
      <div class="amount-input" [class.focused]="amountInputFocused">
        <input type="number" placeholder="0,00" (focus)="amountInputFocused = true"
          (blur)="amountInputFocused = false" />
        <div class="currency-selector">
          <div class="dropdown" (click)="toggleDropdown('currency'); $event.stopPropagation()"
            [class.open]="dropdownOpen === 'currency'">
            <button class="dropdown-btn" [class.focused]="dropdownOpen === 'currency'">
              <img *ngIf="selectedCurrency.icon" [src]="selectedCurrency.icon" class="icon" />
              {{ selectedCurrency.name }}
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
                stroke="currentColor" class="chevron" [class.open]="dropdownOpen === 'currency'">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
              </svg>
            </button>
            <div class="dropdown-menu" *ngIf="dropdownOpen === 'currency'" (click)="$event.stopPropagation()">
              <input type="text" #searchCurrencyInput [value]="searchCurrency"
                (input)="onSearch('currency', searchCurrencyInput.value)" placeholder="T√¨m ki·∫øm" class="search-box"
                (click)="$event.stopPropagation()" />
              <div class="dropdown-item" *ngFor="let currency of filteredCurrencyList"
                (click)="selectCurrency(currency)">
                <img [src]="currency.icon" class="icon" />
                {{ currency.name }}
                <span *ngIf="currency.name === selectedCurrency.name">‚úî</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Dropdown ph∆∞∆°ng th·ª©c -->
      <div class="dropdown" (click)="toggleDropdown('method'); $event.stopPropagation()"
        [class.open]="dropdownOpen === 'method'">
        <button class="dropdown-btn">
          {{ getSelectedPaymentLabel() }}
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"
            class="chevron" [class.open]="dropdownOpen === 'method'">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
          </svg>
        </button>

        <div class="dropdown-menu" *ngIf="dropdownOpen === 'method'" (click)="$event.stopPropagation()">
          <input type="text" #searchPaymentInput [value]="searchPayment"
            (input)="onSearch('payment', searchPaymentInput.value)" placeholder="T√¨m ki·∫øm" class="search-box"
            (click)="$event.stopPropagation()" />
          <label class="dropdown-item" *ngFor="let method of filteredPaymentMethods()">
            <input type="checkbox" [(ngModel)]="method.selected" (change)="togglePaymentSelection(method)" />
            {{ method.name }}
          </label>
        </div>
      </div>
      <!-- <button class="filter-button">üîç</button> -->
    </div>

    <div class="filter-right">
      <div class="dropdown" (click)="toggleDropdown('sort'); $event.stopPropagation()"
        [class.open]="dropdownOpen === 'sort'">
        <button class="dropdown-btn">
          {{ selectedSortOption?.label || 'S·∫Øp x·∫øp theo' }}
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"
            class="chevron" [class.open]="dropdownOpen === 'sort'">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
          </svg>
        </button>

        <div class="dropdown-menu" *ngIf="dropdownOpen === 'sort'" (click)="$event.stopPropagation()">
          <div class="dropdown-header">
            <strong>ƒê∆∞·ª£c khuy√™n ngh·ªã</strong>
            <div class="subtext">ƒê√£ x·∫øp h·∫°ng theo ch·∫•t l∆∞·ª£ng t·ªïng th·ªÉ c·ªßa Nh√† qu·∫£ng c√°o</div>
          </div>
          <div class="dropdown-item" *ngFor="let option of sortOptions" (click)="selectSortOption(option)">
            {{ option.label }}
            <span *ngIf="option.value === selectedSortOption?.value">‚úî</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- B·∫£ng qu·∫£ng c√°o -->
  <table class="ads-table">
    <thead>
      <tr>
        <th>Nh√† qu·∫£ng c√°o</th>
        <th>ƒê∆°n gi√°</th>
        <th>Gi·ªõi h·∫°n kh·∫£ d·ª•ng/Gi·ªõi h·∫°n l·ªánh</th>
        <th>Ph∆∞∆°ng th·ª©c thanh to√°n</th>
        <th>Mua/B√°n</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let ad of filteredAdsToShow">
        <td data-label="Nh√† qu·∫£ng c√°o">
          <strong>{{ ad.name }}</strong><br />
          Giao d·ªãch {{ ad.trades }} ‚Ä¢ Ho√†n t·∫•t {{ ad.successRate }} ‚Ä¢ {{ ad.satisfaction }}<br />
          <span class="status-time">
            ‚óè ƒêang online
            <span *ngIf="ad.time"> ‚Ä¢ {{ ad.time }}</span>
          </span>
        </td>
        <td data-label="ƒê∆°n gi√°">
          <strong>{{ ad.price | number }} VND</strong>
        </td>
        <td data-label="Gi·ªõi h·∫°n">
          {{ ad.available }} USDT<br />{{ ad.range }} VND
        </td>
        <td data-label="Ph∆∞∆°ng th·ª©c thanh to√°n">
          {{ ad.bank }}
        </td>
        <td data-label="">
          <button class="buy-btn" [ngClass]="{ 'sell': activeTab === 'sell' }" (click)="openBuyModal(ad)">
            {{ activeTab === 'buy' ? 'Mua' : 'B√°n' }}
          </button>
        </td>
      </tr>
    </tbody>
  </table>

</div>

<!-- **************** -->
<!-- Modal Mua/B√°n -->
<div class="buy-modal-backdrop" *ngIf="showBuyModal">
  <div class="buy-modal">
    <button class="modal-close-btn" (click)="closeBuyModal()">‚úï</button>

    <div class="modal-content-2col">
      <!-- B√™n tr√°i: Th√¥ng tin ng∆∞·ªùi ƒëƒÉng qu·∫£ng c√°o -->
      <div class="modal-left">
        <h3>{{ selectedAd?.name }}</h3>
        <p>Giao d·ªãch: {{ selectedAd?.trades }}</p>
        <p>T·ª∑ l·ªá ho√†n t·∫•t: {{ selectedAd?.successRate }}</p>
        <p>M·ª©c ƒë·ªô h√†i l√≤ng: {{ selectedAd?.satisfaction }}</p>
      </div>

      <!-- B√™n ph·∫£i: Form -->
      <div class="modal-right">
        <div class="modal-info">
          <p><strong>Gi√°:</strong> {{ selectedAd?.price | number }} VND
            <span class="countdown">({{ countdown }}s)</span>
          </p>
          <p><strong>Gi·ªõi h·∫°n:</strong> {{ selectedAd?.range }} VND</p>
        </div>

        <!-- MUA -->
        <ng-container *ngIf="activeTab === 'buy'">
          <!-- S·ªë ti·ªÅn -->
          <div class="modal-input-group">
            <label>S·ªë ti·ªÅn (VND):</label>
            <div class="input-with-suffix">
              <input type="number" [(ngModel)]="inputBuyAmount" placeholder="0" />
              <span class="suffix">VND</span>
            </div>
          </div>

          <!-- Nh·∫≠n ƒë∆∞·ª£c -->
          <div class="modal-input-group">
            <label>B·∫°n nh·∫≠n ƒë∆∞·ª£c ({{ selectedCoin.name }}):</label>
            <div class="input-with-suffix">
              <input type="text" [value]="receiveAmount" disabled />
              <span class="suffix">{{ selectedCoin.name }}</span>
            </div>
          </div>
        </ng-container>

        <!-- B√ÅN -->
        <ng-container *ngIf="activeTab === 'sell'">
          <!-- B·∫°n b√°n -->
          <div class="modal-input-group">
            <label>B·∫°n b√°n ({{ selectedCoin.name }}):</label>
            <div class="input-with-suffix">
              <input type="number" [(ngModel)]="sellAmount" placeholder="0,00" />
              <span class="suffix">{{ selectedCoin.name }}</span>
            </div>
          </div>

          <!-- B·∫°n nh·∫≠n -->
          <div class="modal-input-group">
            <label>B·∫°n nh·∫≠n (VND):</label>
            <div class="input-with-suffix">
              <input type="text" [value]="sellAmount * selectedAd?.price | number:'1.0-0'" disabled />
              <span class="suffix">VND</span>
            </div>
          </div>

          <p class="limit-note">Gi·ªõi h·∫°n l·ªánh: {{ selectedAd?.range }} VND</p>
        </ng-container>

        <!-- Dropdown ng√¢n h√†ng d√πng chung -->
        <div class="dropdown" (click)="toggleDropdown('bank'); $event.stopPropagation()"
          [class.open]="dropdownOpen === 'bank'">
          <button class="dropdown-btn">
            {{ selectedBankMethod || 'Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n' }}
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
              stroke="currentColor" class="chevron" [class.open]="dropdownOpen === 'bank'">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
            </svg>
          </button>
          <div class="dropdown-menu bank" *ngIf="dropdownOpen === 'bank'">
            <input type="text" [(ngModel)]="searchBank" class="search-box" placeholder="T√¨m ki·∫øm ng√¢n h√†ng" />
            <div class="dropdown-item" *ngFor="let method of filteredBankMethods()" (click)="selectBankMethod(method)">
              {{ method }}
            </div>
          </div>
        </div>

        <!-- C·∫£nh b√°o n·∫øu b√°n -->
        <ng-container *ngIf="activeTab === 'sell' && !isBankMatched">
          <p class="warning-text">
            ƒê·ªëi t√°c ch·ªâ ch·∫•p nh·∫≠n thanh to√°n qua <strong>{{ selectedAd?.bank }}</strong>.<br />
            <a href="#">Th√™m ph∆∞∆°ng th·ª©c thanh to√°n ‚Üí</a>
          </p>
        </ng-container>

        <!-- N√∫t x√°c nh·∫≠n -->
        <button class="confirm-btn" [disabled]="activeTab === 'buy' ? !isBuyFormValid : !isSellFormValid"
          (click)="openConfirmModal()">

          {{ activeTab === 'buy' ? 'X√°c nh·∫≠n mua' : 'B√°n ' + selectedCoin.name + ' v·ªõi m·ª©c ph√≠ b·∫±ng 0' }}

        </button>

      </div>
    </div>
  </div>
</div>

<!-- Modal X√°c nh·∫≠n giao d·ªãch -->
<div class="confirm-modal-backdrop" *ngIf="showConfirmModal">
  <div class="confirm-modal">
    <button class="modal-close-btn" (click)="showConfirmModal = false">‚úï</button>

    <h3>Chi ti·∫øt l·ªánh</h3>
    <div class="confirm-info">
      <p><strong>ƒê∆°n gi√°:</strong> {{ selectedAd?.price | number }} VND ({{ countdown }}s)</p>
      <p><strong>S·ªë l∆∞·ª£ng:</strong> {{ receiveAmount }} {{ selectedCoin.name }}</p>
      <p><strong>Gi√° tr·ªã ƒë·∫∑t l·ªánh:</strong> {{ inputBuyAmount | number:'1.0-0' }} VND</p>
      <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> {{ selectedBankMethod }}</p>
    </div>

    <p class="disclaimer">
      Khi ti·∫øp t·ª•c, t√¥i ƒë√£ ƒë·ªçc v√† ƒë·ªìng √Ω v·ªõi
      <a href="#">Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám v·ªÅ giao d·ªãch P2P</a>
    </p>

    <div class="modal-actions">
      <button class="back-btn " (click)="showConfirmModal = false; showBuyModal = true">Quay l·∫°i</button>
      <button class="confirm-btn black" (click)="submitOrder()">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>