<div class="p2p-container">
  <!-- Thanh Mua/B√°n v√† T·∫°o qu·∫£ng c√°o -->
  <div class="top-bar">
    <div class="tabs">
      <span [class.active]="activeTab === 'buy'" (click)="activeTab = 'buy'">Mua</span>
      <span [class.active]="activeTab === 'sell'" (click)="activeTab = 'sell'">B√°n</span>
    </div>
    <button class="create-ad" (click)="CreateAdsPage()">T·∫°o qu·∫£ng c√°o</button>
  </div>

  <!-- B·ªô l·ªçc -->
  <div class="filters">
    <div class="filter-left">
      <div class="dropdown" [class.open]="dropdownOpen === 'coin'" (click)="$event.stopPropagation()">

        <button class="dropdown-btn" (click)="toggleDropdown('coin')">
          <img *ngIf="selectedCoin.icon" [src]="selectedCoin.icon" class="icon" />
          {{ selectedCoin.name }}
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"
            class="chevron" [class.open]="dropdownOpen === 'coin'">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
          </svg>
        </button>

        <div class="dropdown-menu" *ngIf="dropdownOpen === 'coin'">
          <input type="text" #searchCoinInput [value]="searchCoin" (input)="onSearch('coin', searchCoinInput.value)"
            placeholder="T√¨m ki·∫øm" class="search-box" (click)="$event.stopPropagation()" />
          <div class="dropdown-item" *ngFor="let coin of filteredCoinList" (click)="selectCoin(coin)">
            <img [src]="coin.icon" class="icon" />
            {{ coin.name }}
            <span *ngIf="coin.name === selectedCoin.name">‚úî</span>
          </div>
        </div>
      </div>
      <div class="amount-input" [class.focused]="amountInputFocused">
        <input type="number" placeholder="0,00" [(ngModel)]="inputAmount" (ngModelChange)="onAmountChange()"
          (focus)="amountInputFocused = true" (blur)="amountInputFocused = false" min="0" />
        <div class="currency-selector">
          <div class="dropdown" (click)="toggleDropdown('currency'); $event.stopPropagation()"
            [class.open]="dropdownOpen === 'currency'">
            <button class="dropdown-btn" [class.focused]="dropdownOpen === 'currency'">
              <img *ngIf="selectedCurrency.icon" [src]="selectedCurrency.icon" class="icon" />
              {{ selectedCurrency.name }}
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
                stroke="currentColor" class="chevron" [class.open]="dropdownOpen === 'currency'">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
              </svg>
            </button>
            <div class="dropdown-menu" *ngIf="dropdownOpen === 'currency'" (click)="$event.stopPropagation()">
              <input type="text" #searchCurrencyInput [value]="searchCurrency"
                (input)="onSearch('currency', searchCurrencyInput.value)" placeholder="T√¨m ki·∫øm" class="search-box"
                (click)="$event.stopPropagation()" />
              <div class="dropdown-item" *ngFor="let currency of filteredCurrencyList"
                (click)="selectCurrency(currency)">
                <img [src]="currency.icon" class="icon" />
                {{ currency.name }}
                <span *ngIf="currency.name === selectedCurrency.name">‚úî</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Dropdown ph∆∞∆°ng th·ª©c -->
      <div class="dropdown" (click)="toggleDropdown('method'); $event.stopPropagation()"
        [class.open]="dropdownOpen === 'method'">
        <button class="dropdown-btn">
          {{ getSelectedPaymentLabel() }}
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"
            class="chevron" [class.open]="dropdownOpen === 'method'">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
          </svg>
        </button>

        <div class="dropdown-menu" *ngIf="dropdownOpen === 'method'" (click)="$event.stopPropagation()">
          <input type="text" #searchPaymentInput [value]="searchPayment"
            (input)="onSearch('payment', searchPaymentInput.value)" placeholder="T√¨m ki·∫øm" class="search-box"
            (click)="$event.stopPropagation()" />
          <label class="dropdown-item" *ngFor="let method of filteredPaymentMethods()">
            <input type="checkbox" [(ngModel)]="method.selected" (change)="togglePaymentSelection(method)" />
            {{ method.name }}
          </label>
        </div>
      </div>
      <!-- <button class="filter-button">üîç</button> -->
    </div>

    <div class="filter-right">
      <div class="dropdown" (click)="toggleDropdown('sort'); $event.stopPropagation()"
        [class.open]="dropdownOpen === 'sort'">
        <button class="dropdown-btn">
          {{ selectedSortOption?.label || 'S·∫Øp x·∫øp theo' }}
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"
            class="chevron" [class.open]="dropdownOpen === 'sort'">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
          </svg>
        </button>

        <div class="dropdown-menu" *ngIf="dropdownOpen === 'sort'" (click)="$event.stopPropagation()">
          <div class="dropdown-header">
            <strong>ƒê∆∞·ª£c khuy√™n ngh·ªã</strong>
            <div class="subtext">ƒê√£ x·∫øp h·∫°ng theo ch·∫•t l∆∞·ª£ng t·ªïng th·ªÉ c·ªßa Nh√† qu·∫£ng c√°o</div>
          </div>
          <div class="dropdown-item" *ngFor="let option of sortOptions" (click)="selectSortOption(option)">
            {{ option.label }}
            <span *ngIf="option.value === selectedSortOption?.value">‚úî</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- B·∫£ng qu·∫£ng c√°o -->
  <table class="ads-table">
    <thead>
      <tr>
        <th>Nh√† qu·∫£ng c√°o</th>
        <th>ƒê∆°n gi√°</th>
        <th>Gi·ªõi h·∫°n kh·∫£ d·ª•ng/Gi·ªõi h·∫°n l·ªánh</th>
        <th>Ph∆∞∆°ng th·ª©c thanh to√°n</th>
        <th>Mua/B√°n</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let ad of filteredAdsToShow">
        <td data-label="Nh√† qu·∫£ng c√°o">
          <strong>{{ ad.name }}</strong><br />
          Giao d·ªãch {{ ad.trades }} ‚Ä¢ Ho√†n t·∫•t {{ ad.successRate }} ‚Ä¢ {{ ad.satisfaction }}<br />
          <span class="status-time">
            ‚óè ƒêang online
            <span *ngIf="ad.time"> ‚Ä¢ {{ ad.time }}</span>
          </span>
        </td>
        <td data-label="ƒê∆°n gi√°" class="price">
          <strong>{{ ad.price | number }} VND</strong>
        </td>
        <td data-label="Gi·ªõi h·∫°n" class="limit-info">
          {{ ad.available }} USDT<br />{{ ad.range }} VND
        </td>
        <td data-label="Ph∆∞∆°ng th·ª©c thanh to√°n">
          <div *ngFor="let method of ad.paymentMethods">
            <span>{{ method }}</span>
          </div>
        </td>
        <td data-label="">
          <button class="buy-btn" [ngClass]="{ 'sell': activeTab === 'sell' }" (click)="openBuyModal(ad)">
            {{ activeTab === 'buy' ? 'Mua' : 'B√°n' }}
          </button>
        </td>
      </tr>
    </tbody>
  </table>

</div>

<!-- **************** -->
<!-- Modal Mua/B√°n -->
<div class="buy-modal-backdrop" *ngIf="showBuyModal" (click)="closeBuyModal()">
  <div class="buy-modal new-modal-style" (click)="onModalClick($event); $event.stopPropagation()">
    <button class="modal-close-btn" (click)="closeBuyModal()">‚úï</button>
    <div class="modal-content-2col">
      <!-- Panel tr√°i: Th√¥ng tin ng∆∞·ªùi b√°n -->
      <div class="modal-left dark-panel">
        <div class="advertiser-info">
          <div class="avatar">{{ selectedAd?.name.charAt(0) }}</div>
          <div class="merchant-details">
            <div class="merchant-name">
              <h3>{{ selectedAd?.name }}</h3>
              <span class="verified-dot"></span>
              <span class="verified-badge">‚úî ID ƒë√£ x√°c minh</span>
            </div>
          </div>
        </div>
        <div class="trade-stats">
          <p><span>C√°c l·ªánh ƒë√£ ho√†n t·∫•t</span> <span>{{ selectedAd?.trades | number }}</span></p>
          <p><span>T·ª∑ l·ªá ho√†n t·∫•t</span> <span>{{ selectedAd?.successRate }}</span></p>
          <p><span>C·ª≠a s·ªï thanh to√°n</span> <span>10 ph√∫t</span></p>
          <p><span>T√™n</span> <span>T**</span></p>
        </div>
        <hr>
        <div class="trade-conditions">
          <h4>ƒêi·ªÅu kho·∫£n giao d·ªãch</h4>
          <p>Vui l√≤ng ƒë·∫£m b·∫£o r·∫±ng t√†i kho·∫£n nh·∫≠n kh·ªõp v·ªõi t√™n t√†i kho·∫£n OKX ƒë√£ x√°c minh c·ªßa b·∫°n. B·∫°n c√≥ th·ªÉ li√™n h·ªá v·ªõi
            t√¥i n·∫øu g·∫∑p ph·∫£i b·∫•t k·ª≥ v·∫•n ƒë·ªÅ n√†o tr∆∞·ªõc khi ƒë∆∞a ra tranh ch·∫•p.</p>
        </div>
      </div>
      <!-- Panel ph·∫£i: Giao d·ªãch -->
      <div class="modal-right light-panel">
        <div class="modal-info">
          <p><strong>ƒê∆°n gi√° {{ selectedAd?.price | number }} VND</strong>
            <span class="countdown">({{ countdown }}s)</span>
          </p>
        </div>
        <!-- MUA -->
        <ng-container *ngIf="activeTab === 'buy'">
          <div class="modal-input-group">
            <label>B·∫°n tr·∫£</label>
            <div class="input-with-suffix">
              <input type="number" [(ngModel)]="inputBuyAmount" (ngModelChange)="onBuyAmountChange()" placeholder="0,00"
                min="0" />
              <span class="suffix-icon"><img [src]="currencyList[0].icon" class="icon" /> {{ currencyList[0].name
                }}</span>
            </div>
          </div>
          <div class="modal-input-group">
            <label>B·∫°n nh·∫≠n</label>
            <div class="input-with-suffix">
              <input type="text" [value]="receiveAmount" disabled />
              <span class="suffix-icon"><img [src]="selectedCoin.icon" class="icon" /> {{ selectedCoin.name }}</span>
            </div>
          </div>
          <p class="limit-note">Gi·ªõi h·∫°n l·ªánh: {{ selectedAd?.range }} VND</p>
        </ng-container>
        <!-- B√ÅN -->
        <ng-container *ngIf="activeTab === 'sell'">
          <div class="modal-input-group">
            <label>B·∫°n b√°n</label>
            <div class="input-with-suffix">
              <input type="number" [(ngModel)]="sellAmount" (ngModelChange)="onSellAmountChange()" placeholder="0,00"
                min="0" />
              <span class="suffix-icon">
                <div class="currency-icon usdt-icon">T</div>
                {{ selectedCoin.name }}
              </span>
            </div>
            <div class="availability-info">
              <span>Kh·∫£ d·ª•ng {{ selectedAd?.available }} {{ selectedCoin.name }}</span>
              <a href="#">Qu·∫£n l√Ω ti·ªÅn</a>
            </div>
          </div>
          <div class="modal-input-group">
            <label>B·∫°n nh·∫≠n</label>
            <div class="input-with-suffix">
              <input type="text" [value]="sellAmount * selectedAd?.price | number:'1.0-0'" disabled />
              <span class="suffix-icon">
                <div class="currency-icon vnd-icon">‚Ç´</div>
                {{ currencyList[0].name }}
              </span>
            </div>
          </div>
          <p class="limit-note">Gi·ªõi h·∫°n l·ªánh: {{ selectedAd?.range }} VND</p>
        </ng-container>
        <!-- Dropdown ng√¢n h√†ng -->
        <div class="dropdown bank-dropdown" (click)="toggleDropdown('bank'); $event.stopPropagation()"
          [class.open]="dropdownOpen === 'bank'">
          <button class="dropdown-btn">
            <span>{{ selectedBankMethod || 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng' }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3"
              stroke="currentColor" class="chevron" [class.open]="dropdownOpen === 'bank'">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
            </svg>
          </button>
          <div class="dropdown-menu bank" *ngIf="dropdownOpen === 'bank'">
            <div class="dropdown-item" *ngFor="let method of filteredBankMethods()"
              (click)="selectBankMethod(method); $event.stopPropagation()">
              {{ method }}
            </div>
          </div>
        </div>
        <ng-container *ngIf="activeTab === 'sell'">
          <div class="warning-text" style="margin-top: 4px;">
            <span class="red-text">ƒê·ªëi t√°c ch·ªâ ch·∫•p nh·∫≠n thanh to√°n qua Chuy·ªÉn kho·∫£n ng√¢n h√†ng.</span>
            <a href="#" (click)="openPaymentMethodModal(); $event.preventDefault()"> Th√™m ph∆∞∆°ng th·ª©c thanh to√°n <span
                style='font-size:16px;'>&#8594;</span></a>
          </div>
        </ng-container>
        <button class="confirm-btn" [disabled]="(activeTab === 'buy' ? !isBuyFormValid : !isSellFormValid)"
          (click)="openConfirmModal()">
          {{ activeTab === 'buy' ? 'Mua ' + selectedCoin.name : 'B√°n USDT v·ªõi m·ª©c ph√≠ b·∫±ng 0' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal X√°c nh·∫≠n giao d·ªãch -->
<div class="confirm-modal-backdrop" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
  <div class="confirm-modal" (click)="$event.stopPropagation()">
    <button class="modal-close-btn" (click)="closeConfirmModal()">‚úï</button>

    <h3>Chi ti·∫øt l·ªánh</h3>
    <div class="confirm-info">
      <p><strong>ƒê∆°n gi√°:</strong> {{ selectedAd?.price | number }} VND ({{ countdown }}s)</p>
      <p><strong>S·ªë l∆∞·ª£ng:</strong> {{ receiveAmount }} {{ selectedCoin.name }}</p>
      <p><strong>Gi√° tr·ªã ƒë·∫∑t l·ªánh:</strong> {{ inputBuyAmount | number:'1.0-0' }} VND</p>
      <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> {{ selectedBankMethod }}</p>
    </div>

    <p class="disclaimer">
      Khi ti·∫øp t·ª•c, t√¥i ƒë√£ ƒë·ªçc v√† ƒë·ªìng √Ω v·ªõi
      <a href="#">Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám v·ªÅ giao d·ªãch P2P</a>
    </p>

    <div class="modal-actions">
      <button class="back-btn " (click)="closeConfirmModal()">Quay l·∫°i</button>
      <button class="confirm-btn black" (click)="submitOrder()">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>

<!-- Modal Th√™m ph∆∞∆°ng th·ª©c thanh to√°n -->
<div class="payment-method-modal-backdrop" *ngIf="showPaymentMethodModal" (click)="closePaymentMethodModal()">
  <div class="payment-method-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Th√™m ph∆∞∆°ng th·ª©c thanh to√°n</h3>
      <button class="modal-close-btn" (click)="closePaymentMethodModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <!-- Lo·∫°i ti·ªÅn t·ªá -->
      <div class="form-group">
        <label>Lo·∫°i ti·ªÅn t·ªá</label>
        <div class="currency-display">
          <div class="currency-icon vnd-icon">‚Ç´</div>
          <span>VND</span>
        </div>
      </div>

      <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
      <div class="form-group">
        <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
        <div class="payment-method-display">
          <div class="payment-icon">|</div>
          <span>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
        </div>
      </div>

      <!-- Th√¥ng tin b·ªï sung -->
      <div class="info-text">
        M·ªôt s·ªë ph∆∞∆°ng th·ª©c thanh to√°n nh·∫•t ƒë·ªãnh c√≥ th·ªÉ √°p d·ª•ng ph√≠ v√† h·∫°n m·ª©c h·∫±ng ng√†y theo quy ƒë·ªãnh c·ªßa nh√† cung c·∫•p
        d·ªãch v·ª• thanh to√°n. Ngo√†i ra c√≤n c√≥ c√°c t√≠nh nƒÉng ƒë·ªôc ƒë√°o th·ªÉ hi·ªán qua <a href="#" class="link-blue">nh√£n</a>.
      </div>

      <!-- T√™n t√†i kho·∫£n -->
      <div class="form-group">
        <label>T√™n t√†i kho·∫£n *</label>
        <input type="text" [(ngModel)]="paymentForm.accountName" placeholder="" class="form-input" />
      </div>

      <!-- S·ªë t√†i kho·∫£n -->
      <div class="form-group">
        <label>S·ªë t√†i kho·∫£n *</label>
        <input type="number" [(ngModel)]="paymentForm.accountNumber" placeholder="" class="form-input" />
      </div>

      <!-- T√™n ng√¢n h√†ng -->
      <div class="form-group">
        <label>T√™n ng√¢n h√†ng *</label>
        <input type="text" [(ngModel)]="paymentForm.bankName" placeholder="" class="form-input" />
      </div>

      <!-- T√™n chi nh√°nh -->
      <div class="form-group">
        <label>T√™n chi nh√°nh *</label>
        <input type="text" [(ngModel)]="paymentForm.branchName" placeholder="" class="form-input" />
      </div>
    </div>

    <div class="modal-actions">
      <button class="back-btn" (click)="closePaymentMethodModal()">Quay l·∫°i</button>
      <button class="confirm-btn" [disabled]="!isPaymentFormValid" (click)="savePaymentMethod()">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>